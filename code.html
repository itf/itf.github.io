<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2020-07-29 Wed 20:53 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Code</title>
<meta name="generator" content="Org mode">
<meta name="author" content="ivanaf">
<link rel="stylesheet" type="text/css" href="css/org.css"/>
<link rel="icon" href="ico/favicon.ico" type="image/x- icon">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<div class="head">
<div class="title">
<p>
<a href="blog.html">Ivanaf</a>
</p>

</div>

<menu>
<ul class="org-ul">
<li><a href="index.html">Home</a></li>
<li><a href="blog.html">Blog</a></li>
<li><a href="about.html">About</a></li>
<li><a href="resume.html">Resume</a></li>
<li><a href="portfolio.html">Portfolio</a></li>
<li><a href="contact.html">Contact</a></li>
<li><a href="tags.html">Tags</a></li>
<li><a href="projects_ideas.html">Messy Ideas</a></li>
</ul>
</menu>

</div>

<p>
 </p><h1>
Code
 </h1><p>
</p>

<p>
<span class=page-date> <small>
2019-05-24, updated 2020-07-29 &#x2014; <a href="tags.html#tech">#tech</a> <a href="tags.html#code">#code</a>  &nbsp  <a href="index.html">⇦index</a> &#x2013; <a href="index.html">index⇨</a> 
</small> </span> 
</p>
<p>
This is the code that runs this blog! I might as well have it here as well!
</p>

<p>
<a href="tags.html#tech">tags.html#tech</a>
</p>
<div class="org-src-container">
<pre class="src src-elisp">#! /bin/sh
<span style="color: #50a14f;">":"</span><span style="color: #a0a1a7; font-weight: bold;">; </span><span style="color: #a0a1a7;">exec emacs --no-site-file --script "$0" "$@" # -*-emacs-lisp-*- </span>
<span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">The above line is bash trickery  https://stackoverflow.com/questions/6238331/emacs-shell-scripts-how-to-put-initial-options-into-the-script#6259330</span>





<span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">based on http://pragmaticemacs.com/emacs/export-org-mode-headlines-to-separate-files/</span>
<span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">export headlines to separate files</span>
<span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">http://emacs.stackexchange.com/questions/2259/how-to-export-top-level-headings-of-org-mode-buffer-to-separate-files</span>

<span style="color: #a0a1a7; font-weight: bold;">;;; </span><span style="color: #a0a1a7;">Begin config</span>
(<span style="color: #a626a4;">setq</span> org-export-head--html-postamble 
<span style="color: #50a14f;">"&lt;p class=\"author\"&gt;Author: Ivan Tadeu Ferreira Antunes Filho&lt;/p&gt;</span>
<span style="color: #50a14f;">&lt;p class=\"date\"&gt;Date: %T&lt;/p&gt;</span>
<span style="color: #50a14f;">&lt;p class=\"author\"&gt;Github:  &lt;a href=\"https://github.com/itf/\"&gt;github.com/itf&lt;/a&gt;&lt;/p&gt;</span>
<span style="color: #50a14f;">&lt;p class=\"creator\"&gt;Made with %c and &lt;a href=\"https://github.com/itf/org-export-head\"&gt;Org export head&lt;/a&gt; &lt;/p&gt;"</span>)

(<span style="color: #a626a4;">setq</span> org-export-head-tags-page <span style="color: #50a14f;">"Tags"</span>) <span style="color: #a0a1a7; font-weight: bold;">; </span><span style="color: #a0a1a7;">used for the tags to link to a page</span>

(<span style="color: #a626a4;">setq</span> org-export-head-link-files-to-export (list <span style="color: #50a14f;">"file"</span> <span style="color: #50a14f;">"video"</span>)) <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Link types whose paths are gonna be copied with hard links</span>
<span style="color: #a0a1a7; font-weight: bold;">;</span><span style="color: #a0a1a7;">useful if using custom links</span>

(<span style="color: #a626a4;">setq</span> org-export-head-using-video-links t) <span style="color: #a0a1a7; font-weight: bold;">;</span><span style="color: #a0a1a7;">support for [[video:file]] links</span>

<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">End config</span>

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--run-on-temp-copy-buffer</span> (function-to-run <span style="color: #c18401;">&amp;rest</span> args)
  <span style="color: #50a14f; font-style: italic;">"Runs function on a temp buffer with the contents of the original buffer"</span>
  (<span style="color: #a626a4;">save-excursion</span>
    (<span style="color: #a626a4;">let</span> ((temp-buffer (generate-new-buffer <span style="color: #50a14f;">"tmp"</span>)))
      (copy-to-buffer temp-buffer (point-min) (point-max)) 
      (<span style="color: #a626a4;">with-current-buffer</span> temp-buffer 
        (org-mode) 
        (outline-show-all) 
        (apply function-to-run args))
      (kill-buffer temp-buffer))))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head</span> (<span style="color: #c18401;">&amp;optional</span> directory-name backend reexport)
  <span style="color: #50a14f; font-style: italic;">"Updates the hashes and reexport all changed headings if reexport is nil.</span>
<span style="color: #50a14f; font-style: italic;">Reexports all headings if reexport is non-nil"</span>
  (<span style="color: #a626a4;">interactive</span>)
  (<span style="color: #a626a4;">let</span> ((directory-name (<span style="color: #a626a4;">or</span> directory-name (read-directory-name <span style="color: #50a14f;">"Directory:"</span>)))
        (backend (<span style="color: #a626a4;">or</span> backend <span style="color: #50a14f;">"html"</span>)))
    (make-directory directory-name t)
    (org-export-head--run-on-temp-copy-buffer #'org-export-head--modify-buffer-ast directory-name backend reexport)
    (org-export-head--update-hashes)))


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head-reexport</span> (<span style="color: #c18401;">&amp;optional</span> directory-name backend)
  <span style="color: #50a14f; font-style: italic;">"Reexports all the headings"</span>
  (<span style="color: #a626a4;">interactive</span>)
  (org-export-head directory-name backend t))


<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">TODO this function should return a list of hashes to update the original buffer</span>
(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--modify-buffer-ast</span> (directory-path backend reexport)
  <span style="color: #50a14f; font-style: italic;">"Export all subtrees that are *not* tagged with :noexport: to</span>
<span style="color: #50a14f; font-style: italic;">separate files.</span>

<span style="color: #50a14f; font-style: italic;">Subtrees that do not have the :EXPORT_FILE_NAME: property set</span>
<span style="color: #50a14f; font-style: italic;">are exported to a filename derived from the headline text."</span>
  (org-export-head--update-hashes)
  (org-export-expand-include-keyword)

  <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">Create summaries before deleting the posts</span>
  (org-export-head--create-summaries)
  (org-export-head--create-entry-tags) <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">creates tag lists</span>
  <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">Delete content that has already been exported and set it to noreexport</span>
  (<span style="color: #a626a4;">if</span> (not reexport)
      (org-export-head--delete-noreexport))

  

  <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Get headlines, and generate macros (previous post, etc)</span>
  (<span style="color: #a626a4;">let*</span> ((headlines-hash-list (org-export-head--get-headlines))
         (headlines-hash (car headlines-hash-list))
         (headlines-list (cdr headlines-hash-list))
         <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Insert extra things in the headlines-hash to be used for fixing the macros</span>
         <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">To define new headline-level macros, add extra functions here</span>
         (headlines-hash (org-export-head--insert-next-previous-headline headlines-hash headlines-list))
         (headlines-hash (org-export-head--add-title-macro headlines-hash headlines-list))
         <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Now we get global macros such as the index and the reversed index</span>
         (global-macros (org-export-head--generate-index-alist headlines-list headlines-hash))
         

         <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Now we get the templates. At the moment it is only the header</span>
         (header (org-export-head--get-content-subtree-match <span style="color: #50a14f;">"header"</span>))
         <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">And now the footer, for example, for comments</span>
         (footer (org-export-head--get-content-subtree-match <span style="color: #50a14f;">"footer"</span>)))


    <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">For each not noexport/noreexport headline apply the template, i.e. copy contents</span>
    (org-export-head--run-on-each-heading 
     #'(lambda ()
         (org-export-head--insert-on-header header)
         (org-export-head--insert-on-footer footer))
     <span style="color: #50a14f;">"-noexport-noreexport"</span>)

    <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">After applying the template we replace the macros on all places</span>
    (org-export-head--run-on-each-heading 
     #'(lambda ()
         (<span style="color: #a626a4;">let*</span> ((headline-name (org-export-head--headline))
                (headline-alist (gethash headline-name headlines-hash nil))
                (macro-alist (append headline-alist global-macros))) <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">in reverse order so that headline properties can overshadow these</span>
           (org-export-head--replace-headline-macros macro-alist)))
     <span style="color: #50a14f;">"-noexport-noreexport"</span>)

  
    <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Get the parser tree and the headlines that will become files</span>
    (<span style="color: #a626a4;">let*</span>  ((ast (org-element-parse-buffer)))
      
 
        <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Fix links -- order is important. First external than fuzzy links</span>
        (org-element-map ast 'link
          (<span style="color: #a626a4;">lambda</span> (link)
            (<span style="color: #a626a4;">let*</span> ((link (<span style="color: #a626a4;">or</span> (org-export-head--fix-file-external-link-ast directory-path link) link))
                   (link (<span style="color: #a626a4;">or</span> (org-export-head--fix-local-link-ast headlines-hash link) link))))))
      
      <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Convert the buffer to contain the new AST, </span>
      <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">this is needed because the exporter expects the content to be in a buffer</span>
      (erase-buffer) 
      (insert (org-element-interpret-data ast))
      
      
      (outline-show-all)
      
      <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Finally export all the headers</span>
      
      (org-export-head-export-headers directory-path backend))))
  


<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Not everything can be done using the AST, sadly.</span>
<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Org element has no support for adding custom properties to headlines</span>
<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Nor does it have a nice interface to grab the contents without the property drawer</span>
<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Ideally everything would be done using the AST and org-element, since it is </span>
<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Less prone to writting bugs when using it. </span>
<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">So right now it is only used for fixing links</span>

<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">START OF NON AST (non org-element) SESSION</span>
(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--run-on-each-heading</span>(fn match  <span style="color: #c18401;">&amp;rest</span> args)
  <span style="color: #50a14f; font-style: italic;">"Puts the point on each heading and runs the function. Needed for exporting all headings</span>
<span style="color: #50a14f; font-style: italic;">   from  http://pragmaticemacs.com/emacs/export-org-mode-headlines-to-separate-files/"</span>
  (<span style="color: #a626a4;">save-excursion</span>
    (goto-char (point-min))
    (goto-char (re-search-forward <span style="color: #50a14f;">"^*"</span>))
    (set-mark (line-beginning-position))
    (goto-char (point-max))
    (org-map-entries
     (<span style="color: #a626a4;">lambda</span> ()
       (apply fn args))
     match 'region-start-level)
    (deactivate-mark)))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head-export-headers</span> (directory-name backend)
  <span style="color: #50a14f; font-style: italic;">"Exports each heading to directory-name using backend"</span>
  (<span style="color: #a626a4;">if</span> (equal backend <span style="color: #50a14f;">"html"</span>)
      (org-export-head--run-on-each-heading 
       #'(lambda ()
           (org-set-property
            <span style="color: #50a14f;">"EXPORT_FILE_NAME"</span>
            (concat directory-name (org-export-head--escaped-headline)))
           (deactivate-mark)
           (<span style="color: #a626a4;">let</span> ((org-html-postamble org-export-head--html-postamble))
                (<span style="color: #a626a4;">cl-letf</span> (((symbol-function 'org-export-get-reference) (symbol-function 'org-export-get-reference-custom)))
                  (org-html-export-to-html nil t)))
           (set-buffer-modified-p t)) <span style="color: #50a14f;">"-noexport-noreexport"</span>))
  (<span style="color: #a626a4;">if</span> (equal backend <span style="color: #50a14f;">"pdf"</span>)
      (org-export-head--run-on-each-heading 
       #'(lambda ()
           (org-set-property
            <span style="color: #50a14f;">"EXPORT_FILE_NAME"</span>
            (concat directory-name (org-export-head--escaped-headline)))
           (deactivate-mark)
           (org-latex-export-to-pdf nil t)
           (set-buffer-modified-p t)) <span style="color: #50a14f;">"-noexport-noreexport"</span>)))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--goto-header</span>(<span style="color: #c18401;">&amp;optional</span> no-new-line)
  <span style="color: #50a14f; font-style: italic;">"Puts point after property-block if it exists, in an empty line</span>
<span style="color: #50a14f; font-style: italic;">  by creating a new line, unless no-new-line is non nil and returns point"</span>
  (<span style="color: #a626a4;">interactive</span>)
  (org-back-to-heading t)
  (<span style="color: #a626a4;">let*</span> ((beg-end (org-get-property-block))
         (end (cdr beg-end)))
    (goto-char (<span style="color: #a626a4;">or</span> end (point))))
  (goto-char (point-at-bol 2)) <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Advance one line</span>
  (<span style="color: #a626a4;">if</span> (not no-new-line) 
      (<span style="color: #a626a4;">progn</span>
        (newline)
        (goto-char (point-at-bol 0)))) <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Go back one line</span>
  (point))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--goto-footer</span>(<span style="color: #c18401;">&amp;optional</span> no-new-line)
  <span style="color: #50a14f; font-style: italic;">"Puts point at end of ubtree and returns point"</span>
  (<span style="color: #a626a4;">interactive</span>)
  (org-end-of-subtree)
  (<span style="color: #a626a4;">if</span> (not no-new-line) 
      (<span style="color: #a626a4;">progn</span>
        (newline)))
  (point))


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--get-content-subtree-at-point</span>()
  (<span style="color: #a626a4;">interactive</span>)
  <span style="color: #50a14f;">"Gets the content of the subtree at point, performing the necessary includes</span>
<span style="color: #50a14f;">to check if the hash has changed"</span>
  (<span style="color: #a626a4;">save-excursion</span>
    (deactivate-mark t)
    (<span style="color: #a626a4;">let*</span> ((start (org-export-head--goto-header t))
          (end (org-end-of-subtree t))
          (buffer (current-buffer))
          (content (buffer-substring start end))
          (include-re <span style="color: #50a14f;">"^[ \t]*#\\+INCLUDE:"</span>))
      (<span style="color: #a626a4;">if</span> (string-match include-re content)
          (<span style="color: #a626a4;">with-temp-buffer</span>
            (insert content)
            (org-mode)
            (org-export-expand-include-keyword)
            (buffer-string))
      content))))


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--get-summary-at-point</span>(<span style="color: #c18401;">&amp;optional</span> n-paragraphs n-chars)
  <span style="color: #50a14f; font-style: italic;">"Gets the summary of the subtree at point"</span>
  (<span style="color: #a626a4;">interactive</span>)
  (<span style="color: #a626a4;">save-excursion</span>
    (deactivate-mark t)
    (<span style="color: #a626a4;">let*</span> ((n-paragraphs (<span style="color: #a626a4;">or</span> n-paragraphs 1))
           (n-chars (<span style="color: #a626a4;">or</span> n-chars 200))
          (start (org-export-head--goto-header t))
          (endmax (<span style="color: #a626a4;">save-excursion</span> (org-end-of-subtree t)))
          (endparagraph
           (<span style="color: #a626a4;">save-excursion</span>
             (<span style="color: #a626a4;">dotimes</span> (i n-paragraphs)
               (org-forward-paragraph))
             (- (point) 1)))
          (end (min endmax endparagraph (+ start n-chars))))
      (buffer-substring start end))))


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--create-summaries</span>()
  <span style="color: #50a14f; font-style: italic;">"Creates summary for all the headings"</span>
  (org-export-head--run-on-each-heading 
   #'(lambda()
       (<span style="color: #a626a4;">let*</span> ((summary (org-entry-get-with-inheritance <span style="color: #50a14f;">"SUMMARY"</span>))
              (summary (<span style="color: #a626a4;">or</span> summary (org-export-head--get-summary-at-point)))
              (summary (replace-regexp-in-string <span style="color: #50a14f;">"\n"</span> <span style="color: #50a14f;">" "</span> summary)))
         (<span style="color: #a626a4;">if</span> summary
             (org-set-property <span style="color: #50a14f;">"SUMMARY"</span> summary))))
   <span style="color: #50a14f;">"-noexport"</span>))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--create-entry-tags</span>()
  <span style="color: #50a14f; font-style: italic;">"Creates list of tags with lin"</span>
  (org-export-head--run-on-each-heading 
   #'(lambda()
       (<span style="color: #a626a4;">let*</span> ((entry-tags (assoc <span style="color: #50a14f;">"ALLTAGS"</span> (org-entry-properties)))
             (entry-tags (<span style="color: #a626a4;">when</span> entry-tags (delete <span style="color: #50a14f;">""</span> (split-string (cdr entry-tags) <span style="color: #50a14f;">":"</span>))))
             (url org-export-head-tags-page)
             (tags-text-url <span style="color: #50a14f;">""</span>)
             (tags-text <span style="color: #50a14f;">""</span>))
         (<span style="color: #a626a4;">dolist</span> (tag entry-tags)
           (<span style="color: #a626a4;">unless</span> (<span style="color: #a626a4;">or</span> (string= tag <span style="color: #50a14f;">"reexport"</span>) (string= tag <span style="color: #50a14f;">"noexport"</span>) (string= tag <span style="color: #50a14f;">"noreexport"</span>))
             (<span style="color: #a626a4;">setq</span>  tags-text-url (concat tags-text-url <span style="color: #50a14f;">"[[file:"</span> (org-export-head--escape url) <span style="color: #50a14f;">".org::#"</span> tag <span style="color: #50a14f;">"][#"</span>tag<span style="color: #50a14f;">"]] "</span>))  
             (<span style="color: #a626a4;">setq</span>  tags-text (concat tags-text tag <span style="color: #50a14f;">" "</span>))))
         (org-set-property <span style="color: #50a14f;">"TAGSURL"</span> tags-text-url)
         (org-set-property <span style="color: #50a14f;">"TAGSTEXT"</span> tags-text)))
   <span style="color: #50a14f;">"-noexport"</span>))



<span style="color: #a0a1a7; font-weight: bold;">;;; </span><span style="color: #a0a1a7;">HASH code</span>
<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Idea from https://emacs.stackexchange.com/a/39376/20165</span>
(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--update-hashes</span>()
  <span style="color: #50a14f; font-style: italic;">"Updates the hashes of all the headings"</span>
  (org-export-head--run-on-each-heading 
   #'(lambda()
       (<span style="color: #a626a4;">let</span> ((new-hash  (format <span style="color: #50a14f;">"%s"</span> (org-export-head-get-hash-value-content)))
             (old-hash (org-entry-get-with-inheritance <span style="color: #50a14f;">"HASH"</span>))
             (older-hash (org-entry-get-with-inheritance <span style="color: #50a14f;">"PREVIOUS-HASH"</span>))) 
         (<span style="color: #a626a4;">if</span> (not old-hash)
             (<span style="color: #a626a4;">progn</span>
               (org-set-property <span style="color: #50a14f;">"CREATION-DATE"</span> (format-time-string <span style="color: #50a14f;">"%Y-%m-%d"</span>))))
         <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">If there was a change made</span>
         (<span style="color: #a626a4;">if</span> (not (equal new-hash old-hash))
             (<span style="color: #a626a4;">progn</span>
               (org-set-property <span style="color: #50a14f;">"MODIFICATION-DATE"</span> (format-time-string <span style="color: #50a14f;">"%Y-%m-%d"</span>))
               (org-set-property <span style="color: #50a14f;">"HASH"</span> new-hash)))
         <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Setting property is expensive</span>
         (<span style="color: #a626a4;">if</span> (not (equal old-hash older-hash))
               (org-set-property <span style="color: #50a14f;">"PREVIOUS-HASH"</span> (<span style="color: #a626a4;">or</span> old-hash <span style="color: #50a14f;">""</span>)))))
   <span style="color: #50a14f;">"-noexport"</span>))


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head-get-hash-value-content</span>()
  <span style="color: #50a14f; font-style: italic;">"Gets the hash of the subtree at point"</span>
  (org-export-head-hash-function (org-export-head--get-content-subtree-at-point)))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head-hash-function</span>(text)
  <span style="color: #50a14f; font-style: italic;">"Function to calculate the hash of text.</span>
<span style="color: #50a14f; font-style: italic;">Can be changed to something such as (length text) to run even faster.</span>
<span style="color: #50a14f; font-style: italic;">Shouldn't rally affect the time to export unless your file contains over 100 thousand lines of text"</span>
  (md5 text))

<span style="color: #a0a1a7; font-weight: bold;">;;;</span><span style="color: #a0a1a7;">END HASH CODE</span>

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--delete-noreexport</span>()
  <span style="color: #50a14f; font-style: italic;">"Faster export by deleting things that won't be exported so we don't process them and their links"</span>
  (org-export-head--run-on-each-heading 
   #'(lambda()
       (<span style="color: #a626a4;">let</span> ((old-hash (org-entry-get-with-inheritance <span style="color: #50a14f;">"PREVIOUS-HASH"</span>))
             (new-hash (org-entry-get-with-inheritance <span style="color: #50a14f;">"HASH"</span>)))    
         <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">If there was a change made</span>
         (<span style="color: #a626a4;">if</span> (equal new-hash old-hash)
             (<span style="color: #a626a4;">progn</span>
               (org-toggle-tag <span style="color: #50a14f;">"noreexport"</span> 'on)
               <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">faster export by deleting noexport things before processing</span>
               (org-export-head--erase-content-subtree))))) 
   <span style="color: #50a14f;">"-noexport-reexport"</span>))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--erase-content-subtree</span>()
  (<span style="color: #a626a4;">save-excursion</span>
    (<span style="color: #a626a4;">let</span> ((start (org-export-head--goto-header t))
          (end (org-end-of-subtree)))
      (delete-region start end))))



(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--get-headlines</span> ()
  <span style="color: #50a14f; font-style: italic;">"Returns a tuple that contains a hashtable of headline name to Alist of headline properties</span>
<span style="color: #50a14f; font-style: italic;">As well as a list of the headline names"</span>
  (message <span style="color: #50a14f;">"1"</span>)
  (<span style="color: #a626a4;">flet</span> ((make-hash ()
                   (make-hash-table <span style="color: #e44649;">:test</span> 'equal))
         (add-to-hash (hashtable)
                      (puthash (org-export-head--headline) (org-entry-properties) hashtable)))
    (<span style="color: #a626a4;">let</span> ((headlines-hash (make-hash))
          (headlines-list ()))
      (org-export-head--run-on-each-heading 
       #'(lambda()
           
           (add-to-hash headlines-hash)
           (<span style="color: #a626a4;">setq</span> headlines-list (cons (org-export-head--headline) headlines-list)))
       <span style="color: #50a14f;">"-noexport"</span>)
      (cons headlines-hash headlines-list))))


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--headline</span> ()
  <span style="color: #50a14f; font-style: italic;">"Gets the headline title if point is at the headline"</span>
  (nth 4 (org-heading-components)))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--escaped-headline</span> ()
  (org-export-head--escape (org-export-head--headline)))


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--replace-headline-macros</span>(macro-alist)
  <span style="color: #50a14f; font-style: italic;">"Replace macros of the type  They can contain information such as date</span>
<span style="color: #50a14f; font-style: italic;">or previous and next post.</span>
<span style="color: #50a14f; font-style: italic;">Any headline property can be used as a macro of this type."</span>
  (<span style="color: #a626a4;">save-excursion</span>
    <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Let's find the end of the headline as a marker, since it can move</span>
    (<span style="color: #a626a4;">let</span> ((subtree-end-marker  (<span style="color: #a626a4;">save-excursion</span> (org-end-of-subtree) (point-marker)))) 
      <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">End of subtree might change because of macro expansion, so it is recalculated.</span>
      <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">Macros might be substituted for something smaller, so we move the point on to the left at the end.</span>
      (<span style="color: #a626a4;">while</span> (re-search-forward <span style="color: #50a14f;">"\\#\\#\\#</span><span style="color: #000000; font-weight: bold;">\\</span><span style="color: #000000; font-weight: bold;">(</span><span style="color: #50a14f;">[-A-Za-z_]+</span><span style="color: #000000; font-weight: bold;">\\</span><span style="color: #000000; font-weight: bold;">)</span><span style="color: #50a14f;">\\#\\#\\#"</span> (marker-position subtree-end-marker) t)
        (<span style="color: #a626a4;">unless</span> (org-in-src-block-p)
          (<span style="color: #a626a4;">let*</span> ((macro (match-string-no-properties 1))
                 (macro-subs (cdr (assoc macro macro-alist))))
            (<span style="color: #a626a4;">if</span> macro-subs
                (replace-match  macro-subs t t)
              (replace-match <span style="color: #50a14f;">""</span>))
            (backward-char)))))))


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--get-content-subtree-match</span>(match)
  <span style="color: #50a14f; font-style: italic;">"Get content of the subtree that matches \"match\"  </span>
<span style="color: #50a14f; font-style: italic;">Where match is a tag or -tag or combination of them."</span>
  (<span style="color: #a626a4;">save-excursion</span>
  (<span style="color: #a626a4;">let</span> ((content <span style="color: #50a14f;">""</span>)) 
    (org-export-head--run-on-each-heading
     #'(lambda() 
         (<span style="color: #a626a4;">setq</span> content (concat content (org-export-head--get-content-subtree-at-point)))) 
     match)
    content)))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--insert-on-header</span> (text)
  <span style="color: #50a14f; font-style: italic;">"Insert text on the header of the subtree, but after the property box"</span>
  (<span style="color: #a626a4;">save-excursion</span>
    (org-export-head--goto-header)
    (insert text)))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--insert-on-footer</span> (text)
  <span style="color: #50a14f; font-style: italic;">"Insert text on the footer (end) of the subtree"</span>
  (<span style="color: #a626a4;">save-excursion</span>
    (org-export-head--goto-footer)
    (insert text)))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--generate-index-alist</span> (headlines-list headlines-hash)
  <span style="color: #50a14f; font-style: italic;">"Geneates an org list with the index of the website and inserts it in an alist"</span>
  (<span style="color: #a626a4;">let</span> ((index <span style="color: #50a14f;">""</span>)
        (reverse-index <span style="color: #50a14f;">""</span>)
        (index-with-dates <span style="color: #50a14f;">""</span>)
        (index-with-summaries <span style="color: #50a14f;">""</span>)
        (all-tags <span style="color: #50a14f;">"\n"</span>)
        (all-tags-reverse <span style="color: #50a14f;">"\n"</span>)
        (all-tags-with-dates <span style="color: #50a14f;">"\n"</span>)
        (all-tags-with-summaries <span style="color: #50a14f;">"\n"</span>)
        (tags ())
        (tags-indexes ()))
    (<span style="color: #a626a4;">dolist</span> (headline-name headlines-list)
      (<span style="color: #a626a4;">let*</span> ((headline-alist (gethash headline-name headlines-hash nil))
             (entry-tags (assoc <span style="color: #50a14f;">"ALLTAGS"</span> headline-alist))
             (entry-tags (<span style="color: #a626a4;">when</span> entry-tags (delete <span style="color: #50a14f;">""</span> (split-string (cdr entry-tags) <span style="color: #50a14f;">":"</span>))))
             (creation-date (cdr (assoc <span style="color: #50a14f;">"CREATION-DATE"</span> headline-alist)))
             (modification-date (cdr (assoc <span style="color: #50a14f;">"MODIFICATION-DATE"</span> headline-alist)))
             (summary (string-trim (cdr (assoc <span style="color: #50a14f;">"SUMMARY"</span> headline-alist))))
             (index-entry (concat <span style="color: #50a14f;">"- [["</span>headline-name<span style="color: #50a14f;">"]["</span>headline-name<span style="color: #50a14f;">"]]\n"</span>))
             (index-entry-with-date (concat <span style="color: #50a14f;">"- @@html:&lt;b&gt;@@[["</span>headline-name<span style="color: #50a14f;">"]["</span>headline-name<span style="color: #50a14f;">"]]@@html:&lt;/b&gt;@@"</span>
                                       <span style="color: #50a14f;">"@@html:&lt;span class=\"page-date\"&gt;@@"</span>
                                       <span style="color: #50a14f;">" ("</span> creation-date<span style="color: #50a14f;">", updated "</span> modification-date <span style="color: #50a14f;">")"</span>
                                       <span style="color: #50a14f;">"@@html:&lt;/span&gt;@@"</span> <span style="color: #50a14f;">"\n"</span> ))
             (index-entry-with-summary 
              (concat  index-entry-with-date 
                       (<span style="color: #a626a4;">unless</span> (= (length summary) 0) 
                         (concat <span style="color: #50a14f;">"   @@html:&lt;br&gt;@@"</span> summary <span style="color: #50a14f;">"\n"</span>)))))
        
        (<span style="color: #a626a4;">setq</span> index (concat index index-entry))
        (<span style="color: #a626a4;">setq</span> reverse-index (concat index-entry reverse-index))
        (<span style="color: #a626a4;">setq</span> index-with-dates (concat  index-with-dates index-entry-with-date))
        (<span style="color: #a626a4;">setq</span> index-with-summaries (concat  index-with-summaries index-entry-with-summary))

        (<span style="color: #a626a4;">dolist</span> (tag entry-tags)
          (<span style="color: #a626a4;">if</span> (not (member tag tags))
              (<span style="color: #a626a4;">setq</span> tags (cons tag tags)))
          (<span style="color: #a626a4;">dolist</span> (suffix '(<span style="color: #50a14f;">""</span> <span style="color: #50a14f;">"-reverse"</span> <span style="color: #50a14f;">"-with-dates"</span> <span style="color: #50a14f;">"-with-summaries"</span>))
            <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">Initialize tags lists</span>
            (<span style="color: #a626a4;">let</span> ((tag-index-name (upcase (concat tag suffix))))
              (<span style="color: #a626a4;">unless</span> (assoc tag-index-name tags-indexes) 
                (<span style="color: #a626a4;">setq</span> tags-indexes (cons `(,tag-index-name . <span style="color: #50a14f;">""</span>)  tags-indexes)))))

          <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Add tag indexes to list</span>
          (<span style="color: #a626a4;">let*</span> ((tag (upcase tag))
                (tag-reverse (upcase (concat tag <span style="color: #50a14f;">"-reverse"</span>)))
                (tag-with-dates (upcase (concat tag <span style="color: #50a14f;">"-with-dates"</span>)))
                (tag-with-summaries (upcase (concat tag <span style="color: #50a14f;">"-with-summaries"</span>)))
                (tag-assoc (assoc tag tags-indexes))
                (tag-assoc-reverse (assoc tag-reverse tags-indexes))
                (tag-assoc-with-dates (assoc tag-with-dates tags-indexes))
                (tag-assoc-with-summaries (assoc tag-with-summaries tags-indexes))
                (tag-index (cdr tag-assoc))
                (tag-index-reverse (cdr tag-assoc-reverse))
                (tag-index-with-dates (cdr tag-assoc-with-dates))
                (tag-index-with-summaries (cdr tag-assoc-with-summaries)))

            (<span style="color: #a626a4;">setf</span> (cdr tag-assoc) (concat tag-index index-entry))
            (<span style="color: #a626a4;">setf</span> (cdr tag-assoc-reverse) (concat index-entry tag-index-reverse ))
            (<span style="color: #a626a4;">setf</span> (cdr tag-assoc-with-dates) (concat tag-index-with-dates index-entry-with-date))
            (<span style="color: #a626a4;">setf</span> (cdr tag-assoc-with-summaries) (concat tag-index-with-summaries index-entry-with-summary))))))
    
    <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">Now we create an index for all tags, to be able to have tag pages</span>
    (sort tags (<span style="color: #a626a4;">lambda</span> (a b) (string&lt;  a  b))) <span style="color: #a0a1a7; font-weight: bold;">; </span><span style="color: #a0a1a7;">Sort the tags for the index of all tags</span>
    (<span style="color: #a626a4;">dolist</span> (tag tags)
      (<span style="color: #a626a4;">unless</span> (<span style="color: #a626a4;">or</span> (string= tag <span style="color: #50a14f;">"reexport"</span>) (string= tag <span style="color: #50a14f;">"noexport"</span>) (string= tag <span style="color: #50a14f;">"noreexport"</span>))
      (<span style="color: #a626a4;">let*</span> ((tag-reverse (upcase (concat tag <span style="color: #50a14f;">"-reverse"</span>)))
            (tag-with-dates (upcase (concat tag <span style="color: #50a14f;">"-with-dates"</span>)))
            (tag-with-summaries (upcase (concat tag <span style="color: #50a14f;">"-with-summaries"</span>)))
            (tag-with-summaries-list (cdr (assoc tag-with-summaries tags-indexes)))
            (tag-list (cdr (assoc tag tags-indexes)))
            (tag-reverse-list (cdr (assoc tag-reverse tags-indexes)))
            (tag-with-dates-list (cdr (assoc tag-with-dates tags-indexes))))
        (<span style="color: #a626a4;">setq</span> all-tags (concat all-tags <span style="color: #50a14f;">"** "</span> tag <span style="color: #50a14f;">"\n"</span> tag-list))
        (<span style="color: #a626a4;">setq</span> all-tags-reverse (concat all-tags-reverse <span style="color: #50a14f;">"** "</span> tag <span style="color: #50a14f;">"\n"</span> tag-reverse-list))
        (<span style="color: #a626a4;">setq</span> all-tags-with-dates (concat all-tags-with-dates <span style="color: #50a14f;">"** "</span> tag <span style="color: #50a14f;">"\n"</span> tag-with-dates-list))
        (<span style="color: #a626a4;">setq</span> all-tags-with-summaries (concat all-tags-with-summaries <span style="color: #50a14f;">"** "</span> tag <span style="color: #50a14f;">"\n"</span> tag-with-summaries-list)))))
            

    (append 
     (list (cons <span style="color: #50a14f;">"INDEX"</span> index) (cons <span style="color: #50a14f;">"INDEX-REVERSE"</span> reverse-index)  (cons <span style="color: #50a14f;">"INDEX-WITH-DATES"</span> index-with-dates) (cons <span style="color: #50a14f;">"INDEX-WITH-SUMMARIES"</span> index-with-summaries) 
           (cons <span style="color: #50a14f;">"ALL-TAGS"</span> all-tags) (cons <span style="color: #50a14f;">"ALL-TAGS-REVERSE"</span> all-tags-reverse)  (cons <span style="color: #50a14f;">"ALL-TAGS-WITH-DATES"</span> all-tags-with-dates) (cons <span style="color: #50a14f;">"ALL-TAGS-WITH-SUMMARIES"</span> all-tags-with-summaries))
     tags-indexes)))

<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">END OF NON AST (non org-element) SESSION</span>


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--fix-local-link-ast</span> (headlines link)
  <span style="color: #50a14f; font-style: italic;">"Fixes fuzzy links to headlines, so the they point to new files"</span>
  (<span style="color: #a626a4;">flet</span> ((get-hash (element set)
                   (gethash element set nil)))
    (<span style="color: #a626a4;">when</span> (string= (org-element-property <span style="color: #e44649;">:type</span> link) <span style="color: #50a14f;">"fuzzy"</span>)
      (<span style="color: #a626a4;">let*</span> ((path  (org-element-property <span style="color: #e44649;">:path</span> link))
             (new-path (get-hash path headlines))) 
        (<span style="color: #a626a4;">if</span> new-path
          (<span style="color: #a626a4;">let</span> ((link-copy (org-element-copy link)))
            (apply #'org-element-adopt-elements link-copy (org-element-contents link))
            (org-element-put-property link-copy <span style="color: #e44649;">:type</span> <span style="color: #50a14f;">"file"</span>)
            (org-element-put-property link-copy <span style="color: #e44649;">:path</span> (concat (org-export-head--escape path) <span style="color: #50a14f;">".org"</span>))
            (org-element-set-element link link-copy))
          <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">else: need to check if the link is linking to a subheadline</span>
         (<span style="color: #a626a4;">save-excursion</span>         
           (org-link-search path)
           <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">If the same heading contains multiple subheadings, each with the same name; it will simply link to the first one</span>
           (<span style="color: #a626a4;">let</span> ((link-copy (org-element-copy link)))
            (apply #'org-element-adopt-elements link-copy (org-element-contents link))
            (org-element-put-property link-copy <span style="color: #e44649;">:type</span> <span style="color: #50a14f;">"file"</span>)
            (org-element-put-property link-copy <span style="color: #e44649;">:path</span> (concat (org-export-head--escape (org-find-top-headline)) <span style="color: #50a14f;">".org"</span>))
            (org-element-put-property link-copy <span style="color: #e44649;">:search-option</span> (concat <span style="color: #50a14f;">"#"</span> (org-export-head--escape path)))
            (org-element-set-element link link-copy))
           ))))))


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--fix-file-external-link-ast</span> (directory-path link)
  <span style="color: #50a14f; font-style: italic;">"Creates hard links to the external files in the output directory</span>
<span style="color: #50a14f; font-style: italic;">Only modifies links if file exists"</span>
  (<span style="color: #a626a4;">when</span> (<span style="color: #a626a4;">and</span> (member (org-element-property <span style="color: #e44649;">:type</span> link) org-export-head-link-files-to-export)  (file-exists-p (org-element-property <span style="color: #e44649;">:path</span> link)))
    (<span style="color: #a626a4;">let*</span> ((path (org-element-property <span style="color: #e44649;">:path</span> link))
           (link-copy (org-element-copy link))
           (extension (file-name-extension path))
           (img-extensions '(<span style="color: #50a14f;">"jpg"</span> <span style="color: #50a14f;">"tiff"</span> <span style="color: #50a14f;">"png"</span> <span style="color: #50a14f;">"bmp"</span>))
           (link-description (org-element-contents link))
           <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Removes ../ from the releative path of the file to force it to be moved to a subfolder</span>
           <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">of the current dir. This causes some file conflits in edge cases</span>
           <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">e.g: ../images and ../../images will map to the same place. This should be rare in normal usage</span>
           (new-relative-path 
            (concat <span style="color: #50a14f;">"./"</span> (file-name-extension path) <span style="color: #50a14f;">"/"</span> (file-name-nondirectory path)))
           (new-hard-link-path (concat directory-path new-relative-path))
           (new-hard-link-directory (file-name-directory new-hard-link-path)))
      
      <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Fix the AST</span>
      <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">If image, remove description so it will become a real image instead of a link</span>
      (<span style="color: #a626a4;">unless</span> (<span style="color: #a626a4;">or</span> (member extension img-extensions))
        (apply #'org-element-adopt-elements link-copy link-description))
      (org-element-put-property link-copy <span style="color: #e44649;">:path</span> new-relative-path)
      (org-element-set-element link  link-copy)
      
      <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Create hard link folder</span>
      (make-directory new-hard-link-directory t)
      <span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Create hard link, not replacing if it already exists, catching error if file does not exist</span>
      (<span style="color: #a626a4;">condition-case</span> nil
          (add-name-to-file path new-hard-link-path nil)
        (<span style="color: #ff0000; font-weight: bold;">error</span> nil)))))


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--insert-next-previous-headline</span>(headlines-hash headlines-list)
  <span style="color: #50a14f; font-style: italic;">"Decides what is the next and the previous post and create macro"</span>
  (<span style="color: #a626a4;">let*</span> ((temp-list (cons nil headlines-list))
         (len (length headlines-list)))
    (<span style="color: #a626a4;">dotimes</span> (i len)
      (<span style="color: #a626a4;">let*</span> ((previous (nth 0 temp-list))
             (headline-name (nth 1 temp-list))
            (next (nth 2 temp-list))
            (headline (gethash headline-name headlines-hash nil))
            (new-properties 
             (list (cons <span style="color: #50a14f;">"PREVIOUS"</span> (<span style="color: #a626a4;">or</span> next <span style="color: #50a14f;">"index"</span>))
                   (cons <span style="color: #50a14f;">"NEXT"</span> (<span style="color: #a626a4;">or</span> previous <span style="color: #50a14f;">"index"</span>))))
            (headline (append headline new-properties))) <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">In reverse order, to allow headline properties to shadow this.</span>
        (puthash headline-name headline headlines-hash))
        (<span style="color: #a626a4;">setq</span> temp-list (cdr temp-list))))
  headlines-hash)
      
(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--add-title-macro</span>(headlines-hash headlines-list)
  <span style="color: #50a14f; font-style: italic;">"Creates title macro"</span>
  (<span style="color: #a626a4;">let*</span> ((temp-list (cons nil headlines-list))
        (len (length headlines-list)))
    (<span style="color: #a626a4;">dotimes</span> (i len)
      (<span style="color: #a626a4;">let*</span> ((headline-name (nth 1 temp-list))
            (headline (gethash headline-name headlines-hash nil))
            (new-properties 
             (list (cons <span style="color: #50a14f;">"TITLE"</span> headline-name)))
            (headline (append headline new-properties))) <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">In reverse order, to allow headline properties to shadow this.</span>
        (puthash headline-name headline headlines-hash))
        (<span style="color: #a626a4;">setq</span> temp-list (cdr temp-list))))
  headlines-hash)


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--headline-to-file</span>(headline-name)
  <span style="color: #50a14f; font-style: italic;">"Generate the file name of the headline"</span>
  (concat (org-export-head--escape headline-name) <span style="color: #50a14f;">".org"</span>))


(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head--escape</span>(text)
  (<span style="color: #a626a4;">when</span> text
    (<span style="color: #a626a4;">let*</span> ((text (replace-regexp-in-string <span style="color: #50a14f;">" "</span> <span style="color: #50a14f;">"_"</span> text))
           (text (replace-regexp-in-string <span style="color: #50a14f;">"/"</span> <span style="color: #50a14f;">"-"</span> text))
           (text  (replace-regexp-in-string <span style="color: #50a14f;">"[</span><span style="color: #50a14f; font-weight: bold;">^</span><span style="color: #50a14f;">[:alnum:]-_]"</span> <span style="color: #50a14f;">""</span> (downcase text))))
      text)))


<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Nice export headings http://ivanmalison.github.io/dotfiles/#usemyowndefaultnamingschemefororgheadings</span>
(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">imalison:org-get-raw-value</span> (item)
  (<span style="color: #a626a4;">when</span> (listp item)
    (<span style="color: #a626a4;">let*</span> ((property-list (cadr item)))
      (<span style="color: #a626a4;">when</span> property-list (plist-get property-list <span style="color: #e44649;">:raw-value</span>)))))

(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">imalison:generate-name</span> (datum cache)
  (<span style="color: #a626a4;">let</span> ((raw-value (imalison:org-get-raw-value datum)))
    (<span style="color: #a626a4;">if</span> raw-value
        (org-export-head--escape raw-value)
      <span style="color: #a0a1a7; font-weight: bold;">;; </span><span style="color: #a0a1a7;">This is the default implementation from org</span>
      (<span style="color: #a626a4;">let</span> ((type (org-element-type datum)))
        (format <span style="color: #50a14f;">"org%s%d"</span>
                (<span style="color: #a626a4;">if</span> type
                    (replace-regexp-in-string <span style="color: #50a14f;">"-"</span> <span style="color: #50a14f;">""</span> (symbol-name type))
                    <span style="color: #50a14f;">"secondarystring"</span>)
                (<span style="color: #a626a4;">incf</span> (gethash type cache 0)))))))


<span style="color: #a0a1a7; font-weight: bold;">;</span><span style="color: #a0a1a7;">(use-package ox)</span>
<span style="color: #a0a1a7; font-weight: bold;">;  </span><span style="color: #a0a1a7;">:defer t</span>
<span style="color: #a0a1a7; font-weight: bold;">;  </span><span style="color: #a0a1a7;">:config</span>
  (<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-get-reference-custom</span> (datum info)
    <span style="color: #50a14f; font-style: italic;">"Return a unique reference for DATUM, as a string.</span>
<span style="color: #50a14f; font-style: italic;">DATUM is either an element or an object.  INFO is the current</span>
<span style="color: #50a14f; font-style: italic;">export state, as a plist.  Returned reference consists of</span>
<span style="color: #50a14f; font-style: italic;">alphanumeric characters only."</span>
    (<span style="color: #a626a4;">let</span> ((type (org-element-type datum))
          (cache (<span style="color: #a626a4;">or</span> (plist-get info <span style="color: #e44649;">:internal-references</span>)
                     (<span style="color: #a626a4;">let</span> ((h (make-hash-table <span style="color: #e44649;">:test</span> #'eq)))
                       (plist-put info <span style="color: #e44649;">:internal-references</span> h)
                       h)))
          (reverse-cache (<span style="color: #a626a4;">or</span> (plist-get info <span style="color: #e44649;">:taken-internal-references</span>)
                             (<span style="color: #a626a4;">let</span> ((h (make-hash-table <span style="color: #e44649;">:test</span> 'equal)))
                               (plist-put info <span style="color: #e44649;">:taken-internal-references</span> h)
                               h))))
      (<span style="color: #a626a4;">or</span> (gethash datum cache)
          (<span style="color: #a626a4;">let*</span> ((name (imalison:generate-name datum cache))
                 (number (+ 1 (gethash name reverse-cache -1)))
                 (new-name (format <span style="color: #50a14f;">"%s%s"</span> name (<span style="color: #a626a4;">if</span> (&lt; 0 number) (format <span style="color: #50a14f;">"%s%s"</span> <span style="color: #50a14f;">"."</span> number) <span style="color: #50a14f;">""</span>))))
            (puthash name number reverse-cache)
            (puthash datum new-name cache)
            new-name))))



(<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head-other-file</span> (file directory-name <span style="color: #c18401;">&amp;optional</span> reexport)
  <span style="color: #50a14f; font-style: italic;">"Main function of this script"</span>
  (find-file file)
  (make-directory <span style="color: #50a14f;">"../.emacs-saves"</span> t)
  (<span style="color: #a626a4;">let</span> ((backup-directory-alist `((<span style="color: #50a14f;">"."</span> .  <span style="color: #50a14f;">"../.emacs-saves/"</span>)))
        (auto-save-file-name-transforms `((<span style="color: #50a14f;">".*"</span> <span style="color: #50a14f;">"../.emacs-saves/"</span> t))))
    
  (<span style="color: #a626a4;">require</span> '<span style="color: #008b8b;">ox</span>)
  (<span style="color: #a626a4;">require</span> '<span style="color: #008b8b;">cl</span>)
  (<span style="color: #a626a4;">require</span> '<span style="color: #008b8b;">subr-x</span>)
  (org-mode)
  (transient-mark-mode) <span style="color: #a0a1a7; font-weight: bold;">;</span><span style="color: #a0a1a7;">necessary for using org-map-entries</span>
  (outline-show-all) 
  (org-export-head (concat directory-name <span style="color: #50a14f;">"/"</span>) nil reexport)
  (save-buffer)))


<span style="color: #a0a1a7; font-weight: bold;">;;</span><span style="color: #a0a1a7;">Add video links</span>
(<span style="color: #a626a4;">if</span> org-export-head-using-video-links 
    (<span style="color: #a626a4;">progn</span>
      (<span style="color: #a626a4;">defun</span> <span style="color: #0184bc;">org-export-head-export-video</span> (path desc format)
        <span style="color: #50a14f; font-style: italic;">"Format video links for export."</span>
        (<span style="color: #a626a4;">cl-case</span> format
          (html (concat <span style="color: #50a14f;">"&lt;video controls&gt;</span>
<span style="color: #50a14f;">    &lt;source src=\""</span>path<span style="color: #50a14f;">"\"&gt;</span>
<span style="color: #50a14f;">    Sorry, your browser doesn't support embedded videos.</span>
<span style="color: #50a14f;">&lt;/video&gt;"</span> ))
          (latex (format <span style="color: #50a14f;">"\\href{%s}{%s}"</span> path (<span style="color: #a626a4;">or</span> desc path)))
          (otherwise path)))
      (org-link-set-parameters <span style="color: #50a14f;">"video"</span> <span style="color: #e44649;">:export</span> 'org-export-head-export-video)))

(<span style="color: #a626a4;">let</span> ((file  (elt argv 0))
      (dir  (elt argv 1))
      (reexport  (elt argv 2)))
  (<span style="color: #a626a4;">if</span> (<span style="color: #a626a4;">or</span> (not file) (not dir))
      (message <span style="color: #50a14f;">"usage  FILE DIR [export]"</span>)
    (message <span style="color: #50a14f;">"Exportinf %s to %s"</span> file dir)
    (org-export-head-other-file file dir reexport)))
</pre>
</div>


</div></div>
<br>
<div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ivanaf'; // Required - Replace '<example>' with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    var showComments = function() {
    var button = document.getElementById('comment-button')
        button.style.display = 'none'
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        };
    </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<button id="comment-button" onclick="showComments()">Show comments</button>
</div>
<div><div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Ivan Tadeu Ferreira Antunes Filho</p>
<p class="date">Date: 2020-07-29 Wed 20:53</p>
<p class="author">Github:  <a href="https://github.com/itf/">github.com/itf</a></p>
<p class="creator">Made with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.0.50 (<a href="https://orgmode.org">Org</a> mode 9.1.9) and <a href="https://github.com/itf/org-export-head">Org export head</a> </p>
</div>
</body>
</html>
